{
  "hash": "0fadaa6dd222e3d2f2dbc17189b4619b",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Updating PX-files\"\nformat: html\neditor_options: \n  chunk_output_type: console\n---\n\n\n\n\n## Using `pxmake` to update existing PX-files\n\nThe `pxmake` package can also be used to update existing PX-files. This could be adding data for a new year or updating all data because of a mistake in the earlier file. It is not needed to create a whole new PX-file from scratch, but we can use the good work from the existing PX-file.\n\nWe will work with the Rwandan Labour Force Survey where the dataset can be accessed from [The National Institute of Statistics of Rwanda](https://microdata.statistics.gov.rw/index.php/catalog)'s webpage. A PX-file with sex, province and highest attained education has been made for 2023 and now we want to update it with data for 2024. The code for the created PX-file for 2023 can be unfolded below. The topics about time and order used in the code are covered in higher detail in the chapters [Working with time in PX-files](px_files_time.qmd) and [Codes in PX-files](px_files_code.qmd).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Create LFS PX-file for 2023\"}\nlibrary(haven)\nlibrary(tidyverse)\nlibrary(pxmake)\n\n## Import data from stata format\nRW_lfs2023 <- read_dta(\"data/RW_LFS2023.dta\") %>% \n  sjlabelled::as_label()\n\n# Select relevant variables\nRW_lfs2023_tab1 <- RW_lfs2023 %>% \n  # Select year, sex, province and education\n  select(LFS_year, A01, province, B02A) %>% \n  # Remove blank education\n  filter(!is.na(B02A)) %>% \n  count(across(everything()), name = \"freq\")\n\npx_lfs_tab1 <- RW_lfs2023_tab1 %>% \n  px() %>% \n  # Set title\n  px_title(\"Sex, province and highest attained education in Rwanda Labour Force Survey 2023\") %>%\n  # Set a matrix-name\n  px_matrix(\"tab1_lfs\") %>% \n  # Change variable labels\n  px_variable_label(tribble(~`variable-code`, ~`variable-label`,\n                            \"LFS_year\", \"Year\",\n                            \"A01\", \"Sex\",\n                            \"province\", \"Province\",\n                            \"B02A\", \"Education\")) %>% \n  px_add_totals(c(\"A01\", \"province\", \"B02A\")) %>% \n  # Set time variable\n  px_timeval(\"LFS_year\") %>% \n  # Get Total values first\n  px_order(tribble(~`variable-code`, ~code, ~order,\n                   \"A01\", \"Total\", 0,\n                   \"province\", \"Total\", 0,\n                   \"B02A\", \"Total\", 0))\n\npx_save(px_lfs_tab1, \"lfs_tab1.px\")  \n```\n:::\n\n\n\n\n\n### Updating data with a new year\n\nWe have our existing PX-file for the 2023 Rwanda Labour Force Survey and maybe also including earlier years and it has been published to PX-web. Now we want to update so we can also show data for 2024 on PX-web. So first we read in our data for 2024 and select the relevant variables.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nRW_lfs2024 <- read_dta(\"data/RW_LFS2024.dta\") %>% \n  sjlabelled::as_label()\n\nRW_lfs2024_tab1 <- RW_lfs2024 %>% \n  # Select year, sex, province and education\n  select(LFS_year, A01, province, B02A) %>% \n  # Remove blank education\n  filter(!is.na(B02A)) %>% \n  count(across(everything()), name = \"freq\")\n```\n:::\n\n\n\n\nNow we have to read in our existing PX-file, which the `px()` function from `pxmake` can also be used for.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npxweb_lfs_tab1 <- px(\"lfs_tab1.px\")\n```\n:::\n\n\n\n\n\nTo update the data, we can use the function `px_data()` that can both retrieve and modify data in a PX-object in R. We also need to convert the data for 2024 to a PX-object and add totals. So we need to go through a process of:\n\n- Retrieve data from existing PX-file\n- Create data for the new year with added totals\n- Bind the two datasets together\n- Update the data in the existing PX-object\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Retrieve data from existing px-file\npx_lfs_data_existing <- px_data(pxweb_lfs_tab1)\n\n# Create data for the 2024 data\n# Convert to px-object\npx_new_year_data <- px(RW_lfs2024_tab1) %>% \n  # Add totals\n  px_add_totals(c(\"A01\", \"province\", \"B02A\")) %>% \n  # Retrieve data for 2024\n  px_data()\n\n# Bind the two together\nupdated_data <- bind_rows(px_lfs_data_existing, px_new_year_data)\n\n# Add the data to our px-object\n# Note that data in pxweb_lfs_tab1 is not updated, as we save it to another object\npxweb_lfs_tab1_update <- pxweb_lfs_tab1 %>% \n  px_data(updated_data)\n```\n:::\n\n\n\n\nThe code above involved a bit of typing and saving to intermediate objects. The `pxmake` package integrates very well with the pipe operator as shown in the chapter [PX-file from scratch](px_from_scratch.qmd). The code below achieves the same result, but more compressed. However, the code might be harder to read.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Update data in one go\n\npxweb_lfs_tab1_update2 <- pxweb_lfs_tab1 %>% \n  # px_data for updating data in existing object\n  px_data(\n    # Bind datasets together\n    bind_rows(\n      # Retrieve existing data\n      px_data(pxweb_lfs_tab1),\n      # Create data for the new year\n      px(RW_lfs2024_tab1) %>%\n        px_add_totals(c(\"A01\", \"province\", \"B02A\")) %>% \n        px_data())\n  )\n\n# Check if it is identical to output from code above\nidentical(pxweb_lfs_tab1_update, pxweb_lfs_tab1_update2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] TRUE\n```\n\n\n:::\n:::\n\n\n\n\nAgain, the PX-object with the updated data is saved to a new object in R for the sake of clarity in this document, but it could also be overwritten by assigning to `pxweb_lfs_tab1` instead of `pxweb_lfs_tab1_update`.\n\nNow we just save our updated object and it is ready to be uploaded to PX-web. In principle, this could also be added in the code above with a pipe. Note that we in this case overwrite the existing PX-file saved on disk. In production cases, it might be worth considering versioning of the files.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npx_save(pxweb_lfs_tab1_update2, \"lfs_tab1.px\")\n```\n:::\n\n\n\n\nIt is worth noting that updating the data in this case was swift and easy because the input data from the Rwandan Labour Force Survey had the same structure, variable names and labels in 2023 and 2024. If it used other variable names or labels, we would need extra steps to adjust for that. \n\n### Updating metadata\n\nAbove we just updated the data taking advantage of all the metadata already in place. So for instance, we did not need to specify that the variable name `A01` in PX-web should be shown as \"Sex\", because the metadata was already in place from the file with just 2023 data.\n\nThere might also be cases where you want to edit the metadata of an existing PX-file. The PX-file just created above has a title where the year 2023 is included (\"Sex, province and highest attained education in Rwanda Labour Force Survey 2023\"). The title is now inaccurate as we just added 2024 data to the file. So we want to update the title metadata of our PX-file.\n\nIn a simple case we just remove the year 2023 from the title. This can be done very easily with the code below.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npx(\"lfs_tab1.px\") %>% \n  px_title(\"Sex, province and highest attained education in Rwanda Labour Force Survey\") %>% \n  px_save(\"lfs_tab1.px\")\n```\n:::\n\n\n\n\nWe just read in the PX-file, change the title through `px_title()` and save it via `px_save()`.\n\nSometimes we may want to include the years that the data cover in the title of the table, so the user doesn't have to open the table to see which time periods are covered. This could be achieved by simply editing the function above to: `px_title(\"Sex, province and highest attained education in Rwanda Labour Force Survey 2023-2024\")`. \n\nHowever, this would require you to always remember to update the title when updating with a new year. Instead we could retrieve `min()` and `max()` year from the data and use `paste0()` to put the title together.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nyears <- px(\"lfs_tab1.px\") %>% \n  px_data() %>% \n  distinct(LFS_year)\n\npx(\"lfs_tab1.px\") %>% \n  px_title(paste(\"Sex, province and highest attained education in Rwanda Labour Force Survey\",\n                 paste(min(years$LFS_year), max(years$LFS_year), sep = \"-\")\n                 )\n           ) %>% \n  px_save(\"lfs_tab1.px\")\n```\n:::\n\n\n\n\nThe code gets the variable `LFS_year` from the data and assigns only the distinct values to the object `years`. Afterwards, we read in the PX-file, paste together a title with minimum and maximum year and add it to `px_title()` and then save the PX-file again. It is a little more code-heavy, but ensures an automatic update of the title.\n\n### Updating same metadata in multiple files\n\nSometimes it might be the case that we have multiple PX-files where we want to modify the same piece of metadata. The code that can be unfolded creates a second table from the Rwandan Labour Force Survey, where it uses type of locality (urban/rural) instead of province.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Create second LFS PX-file\"}\nRW_lfs2024_tab2 <- RW_lfs2024 %>% \n  # Select year, sex, province and education\n  select(LFS_year, A01, Code_UR, B02A) %>% \n  # Remove blank education\n  filter(!is.na(B02A)) %>% \n  count(across(everything()), name = \"freq\")\n\nRW_lfs2024_tab2 %>% \n  px() %>% \n  # Set title\n  px_title(\"Sex, type of locality and highest attained education in Rwanda Labour Force Survey\") %>%\n  # Set a matrix-name\n  px_matrix(\"tab2_lfs\") %>% \n  # Change variable labels\n  px_variable_label(tribble(~`variable-code`, ~`variable-label`,\n                            \"LFS_year\", \"Year\",\n                            \"A01\", \"Sex\",\n                            \"Code_UR\", \"Type of locality\",\n                            \"B02A\", \"Education\")) %>% \n  px_add_totals(c(\"A01\", \"Code_UR\", \"B02A\")) %>% \n  # Set time variable\n  px_timeval(\"LFS_year\") %>% \n  # Get Total values first\n  px_order(tribble(~`variable-code`, ~code, ~order,\n                   \"A01\", \"Total\", 0)) %>% \n  px_save(\"lfs_tab2.px\")\n```\n:::\n\n\n\n\nHowever, for both tables the metadata for \"unit\" just shows the default value \"units\". In fact it should instead show \"Persons\", but we just forgot to put it in when creating the initial PX-files. Instead of changing both files manually, we simply loop over them.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Input file-names for the loop\nfor (x in c(\"lfs_tab1.px\", \"lfs_tab2.px\")){\n  \n  px(x) %>% # Read file\n    px_units(\"Persons\") %>% # Change units\n    px_save(x) # Save to disk\n  \n}\n```\n:::\n\n\n\n\nThe value for `x` is in the loop replaced by the filename of the PX-file. It reads the file, changes the unit keyword and overwrites the existing PX-file (by using `px_save(x)`). If you don't want to overwrite right away, maybe because you are unsure of your changes, something like `px_save(paste(\"ver2\", x, sep = \"_\"))`.\n\nWe are also not limited to changing one metadata field. Maybe we also want to include a creation date. We just expand our loop. Note that the date must be provided as a character object in `pxmake`, hence the use of `as.character()`.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Input file-names for the loop\nfor (x in c(\"lfs_tab1.px\", \"lfs_tab2.px\")){\n  \n  px(x) %>% # Read file\n    px_units(\"Persons\") %>% # Change units\n    px_creation_date(as.character(Sys.Date())) %>% # Creation date\n    px_save(x) # Save to disk\n  \n}\n```\n:::",
    "supporting": [
      "px_update_files_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}