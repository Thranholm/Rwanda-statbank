{
  "hash": "2c2a569f4ddf86d9c73c4f9d8da55ad0",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"PX-file from scratch\"\nformat: html\neditor_options: \n  chunk_output_type: console\n---\n\n\n\n\n## Small PX-file from scratch\n\nThis guide walks through how to take microdata and create a PX-file. There might be some considerations in this process depending on the types of variables you have in your data. Microdata is understood in the way that each row is an observation, so for population statistics each row will be a person.\n\n### Inspecting data\n\nWe use the test data `greenlanders` from the `pxmake` package, which is a small dataset about the Greenlandic population containing the variables: cohort, gender, age and municipality.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(pxmake)\n\nstr(greenlanders)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ntibble [100 × 4] (S3: tbl_df/tbl/data.frame)\n $ cohort      : chr [1:100] \"A\" \"A\" \"A\" \"A\" ...\n $ gender      : chr [1:100] \"female\" \"female\" \"female\" \"female\" ...\n $ age         : int [1:100] 21 21 24 31 31 36 37 38 38 52 ...\n $ municipality: chr [1:100] \"Sermersooq\" \"Sermersooq\" \"Kujalleq\" \"Kujalleq\" ...\n```\n\n\n:::\n\n```{.r .cell-code}\nhead(greenlanders)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 4\n  cohort gender   age municipality\n  <chr>  <chr>  <int> <chr>       \n1 A      female    21 Sermersooq  \n2 A      female    21 Sermersooq  \n3 A      female    24 Kujalleq    \n4 A      female    31 Kujalleq    \n5 A      female    31 Sermersooq  \n6 A      female    36 Kujalleq    \n```\n\n\n:::\n:::\n\n\n\n\n### Modifying and saving the file\n\nWe also want to use some data manipulation functions so we load the `tidyverse` package, where the pipe operator especially comes in handy.\n\nFirst we calculate a frequency variable for the data\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n\ngl_freq <- greenlanders %>% \n  count(across(everything()), name = \"freq\", .drop = FALSE)\n\nhead(gl_freq)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 5\n  cohort gender   age municipality  freq\n  <chr>  <chr>  <int> <chr>        <int>\n1 A      female    21 Sermersooq       2\n2 A      female    24 Kujalleq         1\n3 A      female    31 Kujalleq         1\n4 A      female    31 Sermersooq       1\n5 A      female    36 Kujalleq         1\n6 A      female    37 Kujalleq         1\n```\n\n\n:::\n:::\n\n\n\n\nNow we can start making our PX-file, adding a title, contact information and more\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngl_freq %>% \n  # converting to px\n  px() %>% \n  # adding title\n  px_title(\"Test file with Greenland sample population\") %>% \n  # adding a matrix-name\n  px_matrix(\"POP1\") %>% \n  # information about units\n  px_units(\"Persons\") %>% \n  # Subject area\n  px_subject_area(\"Population\") %>% \n  # Subject code\n  px_subject_code(\"POP\") %>% \n  # data source\n  px_source(\"Statistics Greenland\") %>% \n  # contact \n  px_contact(\"Emil Thranholm\") %>% \n  # add a total level for variables\n  px_add_totals(c(\"cohort\", \"gender\", \"age\", \"municipality\")) %>% \n  # variable labels, changing names to be displayed in px-web\n  px_variable_label(tribble(~`variable-code`, ~`variable-label`,\n                            \"cohort\", \"Cohort\",\n                            \"gender\", \"Gender\",\n                            \"age\", \"Age\",\n                            \"municipality\", \"Location\")) %>% \n  # saving px-file\n  px_save(\"px_greenland_testfile.px\")\n```\n:::\n\n\n\n\nThis showed how to use a dataset already in R, the next chapter [Updating PX-files](px_update_files.qmd) shows how to import from Stata and convert it to a PX-file. It is the same procedure as shown above, just with a different data source.\n\n## Hierarchies in PX-files\n\nAbove we made a simple PX-file from microdata. However, sometimes we might have a variable with a hierarchical structure. In this case the variable age will be the example, as it can be grouped in multiple ways, e.g. 5-year groups and 10-year groups or other groups.\n\n### Selection lists\n\nCurrently the age variable is in one year groups. It could make sense to group these into 5-year and 10-year groups. Therefore, we make 5 and 10 year groups in our data using the `age_groups()` function from the `AMR` package.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# If not installed\n# install.packages(\"AMR\")\n\nage_classification <- gl_freq %>% \n  mutate(age5 = AMR::age_groups(age, split_at = \"fives\"),\n         age10 = AMR::age_groups(age, split_at = \"tens\")) %>% \n  distinct(age, age5, age10) %>% \n  arrange(age5) %>% \n  select(valuecode = age, valuetext = age,\n         `5 years classes` = age5,\n         `10 years classes` = age10)\n\nhead(age_classification)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 4\n  valuecode valuetext `5 years classes` `10 years classes`\n      <int>     <int> <ord>             <ord>             \n1        18        18 15-19             10-19             \n2        19        19 15-19             10-19             \n3        21        21 20-24             20-29             \n4        24        24 20-24             20-29             \n5        22        22 20-24             20-29             \n6        20        20 20-24             20-29             \n```\n\n\n:::\n:::\n\n\n\n\nThe code above creates a data frame that can be used as input to the function `px_classification()`. It must have a mandatory column `valuecode` indicating the codes in the data for the given variable. The column `valuetext` is also included here, but is only required if there are texts associated with the codes in the PX-file, e.g. when using data for economic activity ([ISIC](https://unstats.un.org/unsd/classifications/Econ/isic) or similar) then the codes may have texts. Any additional column represents an aggregation and the column name, will be the aggregation name shown in PX-web. In this case we have two aggregations `5 years classes` and `10 years classes`. As the column names are the text shown on PX-web the names have been enclosed in backticks (`) to allow for spacing in the name.\n\nNow we use `px_classification` to create the selection lists in R. Afterwards, we use `px_save_classification()` to export the relevant files. It creates a \".vs\" file and one or more \".agg\" files. In very simple terms the \".vs\" file tells PX-web which selection/aggregation lists to use, while the \".agg\" files are the actual aggregations, e.g. five year classes and ten year classes in this case. More information can be found in the documentation for the [PX-file format](https://www.scb.se/en/services/statistical-programs-for-px-files/px-file-format/).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nage_class <- px_classification(name = \"age_select\", prestext = \"Age classification\",\n                               domain = \"age_class\", df = age_classification)\n\npx_save_classification(age_class, getwd())\n```\n:::\n\n\n\n\nThe `name` argument will be the name of the \".vs\" file, in this case it saves the file as \"age_select.vs\". `df` is the data frame with the classification/selection list just created. The `domain` is the name that we need to put in our PX-file to indicate that the PX-file should use the particular selection list. So the code below reads the PX-file to R and sets the domain for `age` as `age_class` (so for the variable `age` the selection lists with the domain `age_class` should be used).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npx(\"px_greenland_testfile.px\") %>% \n  px_domain(tribble(~`variable-code`, ~domain,\n                    \"age\", \"age_class\")) %>% \n  px_save(\"px_greenland_testfile.px\")\n```\n:::\n\n\n\n\nAfterwards, the modified PX-file is saved again and is now ready to be loaded to PX-web and saved in the same folder as the \".vs\" and \".agg\" files.\n\n### Tree like hierarchy\n\nInstead of selection lists, it is also possible to have a hierarchy in a tree-like structure. However, this feature is not yet supported in `pxmake`, hence it is recommended to use the selection lists presented above for now.\n\nIf it is still wished to use the tree like hierarchy, it is a bit more complicated, but can be done through the `HIERARCHIES` keyword in the [PX-file format](https://www.scb.se/en/services/statistical-programs-for-px-files/px-file-format/).\n\n\n\n\n",
    "supporting": [
      "px_from_scratch_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}